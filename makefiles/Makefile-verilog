#-------------------------------------------------------------------------------
#
#  @author	Alexander Zoellner
#  @date	2019/07/21
#  @mail	zoellner.contact<at>gmail.com
#  @file	Makefile-verilog
#
#  brief	Makefile template for simulating a verilog-based hardware
#		design using icarus verilog and gtkwave.
#
#-------------------------------------------------------------------------------

# Simulator to use (icarus verilog)
SIM := iverilog
# Flags for icarus verilog
SIM_FLAGS := -gstrict-ca-eval -gio-range-error -Wall \
		      -Wsensitivity-entire-vector

# Main verilog file without file ending (or arbitrary name)
PROJECT := <main-file>
# Directory containing verilog source files
SRC_DIR := verilog
# Directory containing testbench
TB_DIR  := tb
# Directory to generate files in
BUILD_DIR := build
# GTKWave input file
SIM_FILE := wave.vcd

# Add all verilog files for compilation
SRCS := $(wildcard $(SRC_DIR)/*.v)
# Add testbench
TB :=$(wildcard $(TB_DIR)/*_tb.v)


# Targets
.PHONY: clean sim build_dir wave
# Default when calling 'make'
.DEFAULT: sim

# Generate executable
sim: build_dir
	$(SIM) $(SIM_FLAGS) -o $(BUILD_DIR)/$(PROJECT)_tb $(TB) $(SRCS)

# Execute generated file from icarus verilog and generate GTKWave input
# Start GTKWave with save file
wave:
	cd $(BUILD_DIR) && vvp $(PROJECT)_tb
	gtkwave $(BUILD_DIR)/$(SIM_FILE) -o --save=wave.gtkw

# Create build directory if it does not exist
build_dir:
	mkdir -p $(BUILD_DIR)

# Remove all generated files
clean:
	rm -rf $(BUILD_DIR)/$(PROJECT)_tb
	rm -rf $(BUILD_DIR)/*.vcd
	rm -rf $(BUILD_DIR)/*.vvp
	rm -rf $(BUILD_DIR)/*.fst
