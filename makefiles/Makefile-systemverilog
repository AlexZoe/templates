#-------------------------------------------------------------------------------
#
#  @author	Alexander Zoellner
#  @date	2020/02/04
#  @mail	zoellner.contact<at>gmail.com
#  @file	Makefile-systemverilog
#
#  brief	Makefile template for simulating a sytemverilog-based hardware
#			design using icarus verilog and gtkwave.
#
#			Adds verilog and systemverilog files to simulation source files.
#
#-------------------------------------------------------------------------------

# Simulator to use (icarus verilog)
SIM			:= iverilog
# Flags for icarus verilog (uses systemverilog 2012 standard)
SIM_FLAGS	:= -gstrict-ca-eval -gio-range-error -Wall \
		       -Wsensitivity-entire-vector -g2012 -Y .sv -Y .v

# Main verilog file without file ending (or arbitrary name)
PROJECT		:= <main-file>
# Directory containing verilog source files
SRC_DIR		:= hdl
# Directory containing testbench
TB_DIR		:= tb
# Directory to generate files in
BUILD_DIR	:= build
# GTKWave input file
SIM_FILE	:= wave.vcd

# Add all verilog files for compilation
SRCS		:= $(wildcard $(SRC_DIR)/*.sv) $(wildcard $(SRC_DIR)/*.v)
# Add testbench
TB			:= $(wildcard $(TB_DIR)/*_tb.sv)


# Targets
.PHONY: clean sim build_dir wave
# Default when calling 'make'
.DEFAULT_GOAL := sim

# Generate executable
sim: build_dir
	$(SIM) $(SIM_FLAGS) -o $(BUILD_DIR)/$(PROJECT)_tb $(TB) $(SRCS)

# Execute generated file from icarus verilog and generate GTKWave input
# Start GTKWave with save file
wave:
	cd $(BUILD_DIR) && vvp $(PROJECT)_tb
	gtkwave $(BUILD_DIR)/$(SIM_FILE) -o --save=wave.gtkw

# Create build directory if it does not exist
build_dir:
	mkdir -p $(BUILD_DIR)

# Remove all generated files
clean:
	rm -rf $(BUILD_DIR)/$(PROJECT)_tb
	rm -rf $(BUILD_DIR)/*.vcd
	rm -rf $(BUILD_DIR)/*.vvp
	rm -rf $(BUILD_DIR)/*.fst
	rm -rf *.wave
